/*! Generated by Clam: ntrip */
KISSY.add("ntrip/mods/autocomplete/rich",["node","event","dom","kg/overlay/6.1.3/"],function(a,b){var c=b("node"),d=b("event"),e=b("dom"),f=b("kg/overlay/6.1.3/"),g="query",h="result",i="afterQueryChange",j="results",k="select",l="activeItem",m="hoverItem",n="ks-ac-active",o="ks-ac-hover",p="J_AcItem",q="ks-autocomplete",r="ks-autocomplete-input",s="."+p,t=a.isArray,u=document,v=(u.body,window),w=function(){this.initRich.apply(this,arguments)};return w.ATTRS={width:{value:null,getter:"_getWidth"},enableAutoFill:{value:!0},activeFirstItem:{value:!0},activeItem:{value:null},hoveredItem:{readOnly:!0,value:null},visible:{value:!1},resultsListVisible:{value:!1},enableNoResultsMessage:{value:!0},messageVisible:{value:!1},align:{value:{node:null,points:["bl","tl"],offset:[0,-1],overflow:{adjustX:0,adjustY:0}},setter:"_setAlign"},zIndex:{value:1e4},boundingBoxTemplate:{value:'<div class="ks-ac-header"></div><div class="ks-ac-body">   <div class="ks-ac-message J_AcMessage"></div>   <div class="ks-ac-content J_AcContent">       <div class="J_HotList"></div>       <div class="J_ResultsList"></div>   </div></div><div class="ks-ac-footer"><span></span></div>'},listNodeTemplate:{value:'<div class="ks-ac-list"></div>'},itemNodeTemplate:{value:'<div class="ks-ac-item"></div>'},noResultsMessage:{value:'\u6ca1\u6709"<span class="ks-ac-message-hightlight">{query}</span>"\u76f8\u5173\u7684\u63a8\u8350'},wrapperClass:{value:""},trigger:{value:[]}},w.prototype={initRich:function(){this.overlay=null,this.overlayNode=null,this.contentNode=null,this.resultsListNode=null,this.messageNode=null,this.hotNode=null,this.headerNode=null,this.footerNode=null,this._renderRich(),this._bindRich()},destructor:function(){this.resultsListNode.detach(),this.detach(),this.overlay=null},_renderRich:function(){var b=this.get("inputNode");b.addClass(r);var c=this.get("align");c.node=c.node?c.node:b;var d=this.overlay=new f({align:c,content:this.get("boundingBoxTemplate"),zIndex:this.get("zIndex")});d.render();var e=d.get("el");this.overlayId="J_Ks"+a.guid(),e.prop("id",this.overlayId).addClass(q).attr("tabindex","-1"),""!==this.get("wrapperClass")&&e.addClass(this.get("wrapperClass")),this.overlayNode=e,this.headerNode=e.one(".J_AcHeader"),this.bodyNode=e.one(".J_AcBody"),this.footerNode=e.one(".J_AcFooter"),this.messageNode=e.one(".J_AcMessage").hide(),this.contentNode=e.one(".J_AcContent"),this.hotNode=e.one(".J_HotList").hide(),this.resultsListNode=e.one(".J_ResultsList").hide()},_buildList:function(b){var d=c.one(e.create(this.get("listNodeTemplate")));return a.each(b,function(a){d.append(this._createItemNode(a).data(h,a))},this),d},_createItemNode:function(a){var b=c.one(e.create(this.get("itemNodeTemplate")));return b.addClass(p).append(a.display),b},_bindRich:function(){var b=this.get("inputNode");this.on("afterVisibleChange",this._afterVisibleChange,this),this.on("afterResultsListVisibleChange",this._afterResultsListVisibleChange,this),this.on("afterMessageVisibleChange",this._afterMessageVisibleChange,this),b.on("keydown",a.bind(this._afterKeyDown,this)),b.on("focus",this._onFocus,this),this.on(j,a.bind(this._onResults,this)),this.on(i,this._onQuery,this),this.on("afterActiveItemChange",a.bind(this._afterActiveChange,this)),this.on("afterHoverItemChange",a.bind(this._afterHoverChange,this)),this.on(k,this._onSelect,this);var e=c.one(u),f=a.bind(this._afterDocClick,this);this.overlay.on("afterVisibleChange",function(a){return a.newVal?void e.on("click",f):void e.detach("click",f)},this),d.on(v,"resize",a.buffer(this._syncPosition,100,this),this),this.bindList()},bindList:function(){this.resultsListNode.delegate("mouseenter",s,function(a){var b=c.one(a.currentTarget);this.hoverItem(b)},this),this.resultsListNode.delegate("click",s,function(a){a.preventDefault();var b=c.one(a.currentTarget);this.selectItem(b)},this),this.resultsListNode.on("mouseleave",function(){this.set(m,null)},this)},_onResults:function(b){var c=b.results,d=b.query,e=this.resultsListNode;this._isSelectVal||(t(c)&&c.length>0?(this._clear(),e.empty(),e.append(this._buildList(c)),this.set("messageVisible",!1),this.get("activeFirstItem")&&this.set(l,this._getFirstItem()),u.activeElement==this.inputNode[0]&&this.set("resultsListVisible",!0),this._syncPosition()):(d=a.escapeHTML(d),u.activeElement==this.inputNode[0]&&(this.get("enableNoResultsMessage")?this.showMessage(a.substitute(this.get("noResultsMessage"),{query:d})):(e.empty(),this.set(l,null)))))},showMessage:function(a){this.messageNode.html(a);var b=this;return setTimeout(function(){b.set("messageVisible",!0)},1),this},_syncPosition:function(){var a=this.get("align");this.overlay.align(a.node,a.points,a.offset,a.overflow)},_clear:function(){this.set(l,null),this.set(m,null)},selectItem:function(a){a||(a=this.get(l));var b=a.data(h);return this.fire(k,{node:a,result:b}),this},_afterVisibleChange:function(a){var b=a.newVal;this._syncPosition(),b?(this.overlay.show(),this.overlayNode&&this.overlayNode.show()):(this.overlay.hide(),this.overlayNode&&this.overlayNode.hide())},_afterResultsListVisibleChange:function(a){var b=a.newVal;b?(this.overlay.set("width",this.get("width")),this.resultsListNode.show(),this.set("visible",!0),this._syncPosition()):this.resultsListNode.hide(),""!==this.get(g).query&&a.newVal===!1&&this.get("enableAutoFill")&&this.get(l)&&this.selectItem()},_afterMessageVisibleChange:function(a){var b=a.newVal;b?(this.messageNode.show(),this.set("visible",!0),this._syncPosition()):(this.messageNode.hide(),this.set("visilbe",!1))},_onFocus:function(a){var b=this;b.set("messageVisible",!1),setTimeout(function(){b._isSelectVal||a.currentTarget.select()},100)},_isOutSide:function(a,b){for(var d=0,e=b.length;e>d;d++){var f=b[d][0];if(a===f||c.one(a).parent(function(a){return a===f?!0:void 0}))return!1}return!0},_afterDocClick:function(a){var b=a.target;this._isOutSide(b,[this.overlayNode,this.inputNode].concat(this.get("trigger")))&&(this.set("resultsListVisible",!1),this.set("visible",!1))},_onSelect:function(a){var b=this,c=this.get("inputNode");this._updateValue(a.result.text),this._isSelectVal=!0,setTimeout(function(){b._isSelectVal=!1},200),c[0].focus(),this.set(l,null),this.set("resultsListVisible",!1),this.set("visible",!1)},_onQuery:function(a){0===a.newVal.query.length&&(this.set("resultsListVisible",!1),this.set("messageVisible",!1))},_afterActiveChange:function(a){var b=a.prevVal,c=a.newVal;b&&b.removeClass(n),c&&c.addClass(n)},_afterHoverChange:function(a){var b=a.prevVal,c=a.newVal;b&&b.removeClass(o),c&&c.addClass(o)},_afterKeyDown:function(a){switch(a.keyCode){case 38:a.preventDefault(),this.activePrevItem();break;case 40:a.preventDefault(),this.activeNextItem();break;case 13:a.preventDefault(),this.get("resultsListVisible")&&this.get(l)&&this.selectItem();break;case 9:this.get("resultsListVisible")&&this.get(l)&&(a.preventDefault(),this.selectItem()),this.set("resultsListVisible",!1),this.set("visible",!1);break;case 27:this.set("resultsListVisible",!1),this.set("visible",!1)}},hoverItem:function(a){a&&this.set(m,a)},activeNextItem:function(){var a,b=this.get(l);b?(a=b.next(s),a||(a=this._getFirstItem())):a=this._getFirstItem(),this.set(l,a)},activePrevItem:function(){var a=this.get(l),b=a?a.prev(s)||this._getLastItem():this._getLastItem();this.set(l,b)},_getFirstItem:function(){return this.resultsListNode.one(s)},_getLastItem:function(){return this.resultsListNode.one(s+":last-child")},_getWidth:function(b){return a.isNumber(b)?b:b instanceof NodeList?b.outerWidth():null===b?this.get("inputNode").outerWidth():void 0},_setAlign:function(b){var d={node:null,points:["bl","tl"],offset:[0,-1],overflow:{adjustX:0,adjustY:0}};return a.mix(d,b,void 0,void 0,!0),d.node=a.isString(d.node)?c.one(d.node):d.node,d.node?d:(d.node=this.get("inputNode"),d)}},w});