KISSY.add("tbr/loader",["tbr/config","io","event","node"],function(t,e,n,r){var i=e("tbr/config"),o=e("io"),a=e("event"),s=e("node");return{"load":function(e,n,r){t.inArray(e,["phone","qq","card"])||t.error("\u4e0d\u652f\u6301\u6b64\u7c7b\u578b\u7684\u5145\u503c\u6846"),"card"==e?t.use("tbr/utils/monitor",function(t,e){e.goldlog("/game.7.1.1","","H46747592")}):"qq"==e&&t.use("tbr/utils/monitor",function(t,e){e.goldlog("/game.7.4.1","","H46747592")}),i.start(e,n,function(){t.log("[loader]start to load "+e),t.use(t.substitute("tbr/control/{rechargerType}/index,tbr/request,tbr/url/{rechargerType},tbr/result/{resultType},tbr/buy",{"rechargerType":e,"resultType":t.namespace("tbr",t).resultType||"general"}),function(t,i,l,u,c,d){function h(){this.publish("submit",{"bubbles":!0})}function p(r){var a=this,p=t.namespace("tbr."+e,t).data={},b=t.namespace("tbr."+e,t).itemData={"success":!1},m=null,f=s.one("#tbr-"+r.type);t.mix(r,{"containerNode":f}),f.parent().addClass("tbr-env-fp1"),this.request=new l(r),this.result=new c(r),this.buy=new d(r),this.control=new i(r),this.urlGenerator=new u({"env":"fp"==n?"fp_2012":n}),this.control.on("afterValueChange",function(e){var n;t.mix(p,e.newVal),p.request&&("qq"==r.type&&(Math.floor(10*Math.random())+1>8?(t.log("[loader]requested itemtype is ecard"),p.itemType="ecard"):(t.log("[loader]requested itemtype is tbcp"),p.itemType="tbcp")),n=a.urlGenerator.getRequestUrl(p),""!=n?(t.log("request item via "+n),a.request.get(n,p),m&&(m.cancel(),m=null),m=t.later(function(){a.result.printLoading()},1e3)):"phone"==r.type?(t.log("\u5207\u6362\u9762\u503c\u4ee3\u7801\uff0c\u4e0d\u8bf7\u6c42"),a.result.printPriceIntervals(a.urlGenerator.getIntervalArr(p)),a.result.hideThf(),b.success=!1):(a.result.printError(),b.success=!1))}),this.request.on("success",function(e){b.success=!0,t.mix(b,e.result),m&&(m.cancel(),m=null),a.result.printPrice(e.result),"phone"===r.type&&o({"url":"//tcc.taobao.com/cc/json/getTaoHuaFeeValidFeeByItemList.do","dataType":"jsonp","timeout":5,"cache":!1,"scriptCharset":"gbk","data":{"itemIdList":b.item_id_num,"phoneNo":e.formData?e.formData.number:""},"success":function(t){var e=+t.code;if(0==e){var n=t.data||{},r=n.list||[],i=r[0]||{};a.result.printThf(i)}else a.result.hideThf()},"error":function(t,e){a.result.hideThf()}})}),this.request.on("error",function(t){b.success=!1,m&&(m.cancel(),m=null),a.result.printStockout({"url":a.urlGenerator.getSearchUrl(p)}),"phone"===r.type&&a.result.hideThf()}),this.eventTarget=new h,this.eventTarget.on("submit",function(){a.control.snapshot(),a.buy.submit()}),this.publish("submit",{"bubbles":!0}),this.addTarget(this.eventTarget),this.buy.on("click",function(t){a.control.validate()}),this.buy.on("submit",function(t){a.fire("submit")}),this.control.init()}t.augment(h,a.Target),t.augment(p,a.Target),r&&r(new p({"type":e}))})})}}});KISSY.add("tbr/utils/monitor",[],function(t,e,n,r){var i={},o=window,a=!/g-assets\.daily\.taobao\.net/.test(t.Config.base);return i.sendPmid=function(e){t.log("[monitor]pmid: "+e),a&&t.isString(e)&&""!=e&&(t.log("[monitor]\u6b63\u5e38\u73af\u5883\uff0c\u53d1\u9001pmid"),o.document.createElement("img").src="//ju.mmstat.com/?url=http://go.mmstat.com?logtype=2&ad_id=&am_id=&cm_id=&pm_id="+e)},i.goldlog=function(t,e,n){a&&(o.goldlog_queue||(o.goldlog_queue=[])).push({"action":"goldlog.record","arguments":[t,"",e,n]})},i});