/*! Generated by Clam: ntrip */
KISSY.add("ntrip/mods/autocomplete/base",["node","event","base","io"],function(a,b){function c(){this.initBase.apply(this,arguments)}var d=b("node"),e=(b("event"),b("base"),b("io")),f="inputNode",g="query",h="results",i="results",j="afterQueryChange",k="input",l="requestTemplate",m="resultListLocator";return c.ATTRS={enableCache:{value:!0},inputNode:{value:null,setter:function(a){return d.one(a)}},maxResults:{value:1e3},minQueryLength:{value:1},jsonpCallback:{value:"callback"},query:{value:{query:"",inputValue:""}},queryDelay:{value:100},queryDelimiter:{value:null},requestTemplate:{value:null,setter:"_setRequestTemplate"},resultFilter:{value:null},resultFormatter:{value:function(b,c){return a.map(c,function(b){return a.substitute('<div class="ks-ac-item-inner"><span class="ks-ac-name">{cityname}</span><span class="ks-ac-intro">{py}</span></div>',{cityname:b.text,py:b.raw.py})})}},resultListLocator:{value:null,setter:"_setLocator"},results:{value:[]},resultTextLocator:{value:null,setter:"_setLocator"},source:{value:null,setter:"_setSource"},sourceCharset:{value:void 0},value:{value:"",setter:"_onSetVal"},allowBrowserAutocomplete:{value:!1}},c.prototype={initBase:function(){return this.get("enableCache")===!0&&(this._cache={}),this.inputNode=this.get("inputNode"),this.inputNode?(this._renderUIAcBase(),this._bindUIAcBase(),this):(a.log("error: \u6ca1\u6709\u5bf9\u5e94\u7684\u8f93\u5165\u6846\u8282\u70b9."),!1)},destructor:function(){var a=this.get("inputNode");a.detach()},_renderUIAcBase:function(){this._syncBrowserAutocomplete()},_bindUIAcBase:function(){var b=this.get(f);b.on(k,this._onInputValueChange,this),this.on("afterValueChange",this._afterValueChange,this),this.on(j,function(b){var c=a.trim(b.newVal.query);c.length<this.get("minQueryLength")||this.sendRequest(c)},this),this.on("afterAllowBrowserAutocompleteChange",this._syncBrowserAutocomplete,this)},sendRequest:function(b,c){var d,e=this.get("source");e&&(c||(c=this.get(l)),d=c?c.call(this,b):b,e.sendRequest({query:b,request:d,callback:{success:a.bind(this._onResponse,this,b)}}))},_onSetVal:function(){},_onInputValueChange:function(a){var b=d.one(a.currentTarget).val();this.set("value",b)},_afterValueChange:function(a){var b,c=this,d=a.newVal,e=this.get("queryDelimiter"),f=d;if(null!==e){var h=this._getCursortPosition(this.get("inputNode")[0]),i=d.slice(0,h),j=i.split(e);b=d.split(e);var k=j.length>0?j.length-1:0;f=b[k]}var l=function(){c.set(g,{query:f,inputValue:d})},m=this.get("queryDelay");m?(clearTimeout(this._delay),this._delay=setTimeout(function(){l()},m)):l()},_getCursortPosition:function(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||"0"==a.selectionStart)&&(b=a.selectionStart);return b},_setCaretPosition:function(a,b){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}},_updateValue:function(b){var c,d,e=this.get("queryDelimiter"),f=this.get("inputNode");if(b=a.trim(b),e){c=a.trim(e),d=this.get("value");var g=this._getCursortPosition(f[0]),h=d.slice(0,g),i=h.split(e);d=d.split(e);var j=i.length>0?i.length-1:0;d=a.map(a.trim(this.get("value")).split(e),function(b){return a.trim(b)}),d[j]=b,b=d.join(c)}this.set("value",b,{silent:!0}),f.val(b),e&&this._setCaretPosition(f[0],d.slice(0,j+1).join(c).length)},_onResponse:function(a,b){a===(this.get("query").query||"")&&this._parseResponse(a||"",b.response,b.data)},_parseResponse:function(b,c,d){var e,f,g,j,k,l,n,o,p,q={data:d,query:b,results:[]},r=this.get(m),s=[],t=c&&c.results;if(t&&r&&(t=r.call(this,t)),t&&t.length){for(p=this.get("resultTextLocator"),g=this.get("resultFilter"),j=0,k=t.length;k>j;++j)n=t[j],o=p?p.call(this,n):n.toString(),s.push({display:o,raw:n,text:o});if(g&&(s=g.call(this,b,s.concat())),s.length&&(f=this.get("resultFormatter"),l=this.get("maxResults"),l&&l>0&&s.length>l&&(s.length=l),f))if(e=f.call(this,b,s.concat()))for(j=0,k=e.length;k>j;++j)s[j].display=e[j];else a.log("Formatter didn't return anything.","warn","autocomplete-base")}q.results=s,this.set(h,s),this.fire(i,q)},_sourceSuccess:function(a,b){b.callback.success({data:a,response:{results:a},request:b})},_setEnableCache:function(a){a===!0&&(this._cache={})},_setRequestTemplate:function(b){return a.isFunction(b)?b.call(this,query):function(c){return a.substitute(b,{query:encodeURIComponent(c)})}},_setResultFilter:function(a,b){return b},_setResultHighlighter:function(b){return a.isFunction(b)?b:!1},_setLocator:function(b){if(a.isFunction(b))return b;b=b.toString().split(".");var c=function(a,b){if(!a)return null;for(var c=0,d=b.length;d>c;c++)b[c]in a&&(a=a[b[c]]);return a};return function(a){return a&&c(a,b)}},_setSource:function(b){switch(!0){case a.isString(b):return this._createJsonpSource(b);case a.isFunction(b):return this._createFunctionSource(b);case a.isArray(b):return this._createArraySource(b);case a.isObject(b):return this._createObjectSource(b)}return b},_createJsonpSource:function(b){var c,d={type:"jsonp"},f=this,g=this.get(l);return g&&(b+=g.call(this,query)),d.sendRequest=function(d){c=d;var g=d.request;if(f._cache&&g in f._cache)return void f._sourceSuccess(f._cache[g],d);var h;h=a.substitute(b,{query:d.query,maxResults:f.get("maxResults")}),new e({url:h,dataType:"jsonp",crossDomain:!0,scriptCharset:f.get("sourceCharset"),jsonp:f.get("jsonpCallback"),success:function(a){c===d&&(f._cache&&(f._cache[d.request]=a),f._sourceSuccess(a,d))}})},d},_createArraySource:function(a){var b=this;return{type:"Array",sendRequest:function(c){b._sourceSuccess(a,c)}}},_createFunctionSource:function(a){var b=this;return{type:"function",sendRequest:function(c){var d;(d=a(c.query))&&b._sourceSuccess(d,c)}}},_createObjectSource:function(a){var b=this;return{type:"Object",sendRequest:function(c){b._sourceSuccess(a,c)}}},_syncBrowserAutocomplete:function(){var a=this.get("inputNode");"input"===a.prop("nodeName").toLowerCase()&&a.attr("autocomplete",this.get("_syncBrowserAutocomplete")?"on":"off")}},c});