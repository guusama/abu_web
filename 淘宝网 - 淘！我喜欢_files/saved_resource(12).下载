KISSY.add("tbr/comp/numberTextInput2",["tbr/comp/textInput2","tbr/utils/keycode","event","event-custom","dom"],function(e,t,n,r){function i(e){var t=e;return/^\d*$/.test(e)||(t=e.replace(/\D/g,"")),t}var o=t("tbr/comp/textInput2"),a=t("tbr/utils/keycode"),s=t("event"),l=(t("event-custom"),t("dom"),function(e,t){var n=this;this.textInputNode=e,this.textInputNode.addClass("tbr-number-input"),this.textInput=new o(this.textInputNode,t),this.textInput.on("focus",function(e){n.fire("focus",e)}).on("blur",function(e){n.fire("blur",e)}).on("keydown",function(e){a.inNumberBlacklist(e)?e.preventDefault():n.fire("keydown",e)}).on("keyup",function(e){var t,r=this.getValue();t=i(r),t!=r&&this.load(t),this.updateMaxLength(/^1/.test(t)?11:12),n.fire("keyup",e)}).on("change",function(e){n.fire("change",e)})});return e.augment(l,s.Target,{"validate":function(e){return""},"load":function(t,n){e.isString(t)&&/^\d*$/.test(t)&&(e.log("[number-input]load "+t),this.textInput.load(t,n))},"getValue":function(){return this.textInput.getValue()},"getTextInputNode":function(){return this.textInputNode},"getTextInput":function(){return this.textInput}}),l});KISSY.add("tbr/comp/textInputTip",["dom","base","util","node"],function(t,e,n,i){var o=e("dom"),r=e("base"),a=e("util"),s=e("node"),l=function(e,n){var i=this;l.superclass.constructor.call(this),this.config=t.mix({"inputContainer":".tbr-input"},n),this._inputNode=e,this._isInitialized=!1,this.on("afterContentChange",function(t){i._isInitialized&&i._contentNode.html(t.newVal)}).on("afterAppendToChange",function(t){i._isInitialized&&(i._node.appendTo(t.newVal),i._locate())}),n&&(n.content&&this.set("content",n.content),n.appendTo&&this.set("appendTo",n.appendTo))};return a.extend(l,r,{"show":function(t){this._isInitialized||(this._build(),this._isInitialized=!0),this._locate(),t&&this.set("content",t),this._node.show(),this.fire("show",{"node":this._node})},"hide":function(){this._isInitialized&&this._node.hide()},"_build":function(){this._node=s.one(o.create('<div class="tbr-input-tip"><p></p></div>')),!this.get("appendTo")&&this.set("appendTo",document.body),this._node.appendTo(this.get("appendTo")),this._contentNode=this._node.one("p"),this._contentNode.html(this.get("content")),this._node.prop("id",this._inputNode.prop("id")+"-tip"||"")},"_locate":function(){var t=this.config.inputContainer,e=this._inputNode.parent(t),n=e.offset(),i=o.offset(this.get("appendTo")),r=e.css("border-bottom-width")+"",a=r.match(/^(\d+)(px)?$/);r=a?1*a[1]:0,this._inputNode.parent(".new-service-bd")?(n=this._inputNode.parent(".new-service-bd").offset(),this._node.css("left",i.left-n.left+"px"),this._node.css("top",n.top-i.top+e.outerHeight()-r+6+"px")):(this._node.css("left",n.left-i.left+"px"),this._node.css("top",n.top-i.top+e.outerHeight()-r+"px"))},"isHidden":function(){var t;return t=!this._node||"none"==this._node.css("display")}},{"ATTRS":{"content":{"value":"tbr text input tip.","validator":function(t){return!!t}},"appendTo":{"value":null,"validator":function(t){return!!t}}}}),l});KISSY.add("tbr/comp/textInputMenu",["kg/xtemplate/4.2.0/index","dom","base","util","node","ua"],function(t,e,n,i){var r=e("kg/xtemplate/4.2.0/index"),o=e("dom"),a=e("base"),s=e("util"),l=e("node"),u=e("ua"),d='{{#each(arr)}}<li id="{{id}}-opt-{{index}}" class="{{#if(xindex === 0)}} tbr-top tbr-left{{/if}}" data-index="{{index}}">{{#if(value)}}<a href="//www.taobao.com" tabindex="-1" style="zoom:1;" target="_blank">',c="</a>{{/if}}</li>{{/each}}",h=function(e,n){var i=this;h.superclass.constructor.call(this),this._isInitialized=!1,this._inputNode=e,this.config=t.mix({"inputContainer":".tbr-input"},n),this.set("id",this._inputNode.prop("id")+"-menu"||""),this.on("afterSelectedIndexChange",function(t){var e;t.newVal!=-1&&i._node&&(e=i._node.all("li"),t.prevVal>=0&&l.all(e[t.prevVal]).removeClass("tbr-active"),t.newVal>=0&&l.all(e[t.newVal]).addClass("tbr-active"),this.fire("highlight",{"node":l.one(e[t.newVal])}))})};return s.extend(h,a,{"_show":function(){this.isHidden()&&(this._node&&this._node.show(),this._node.attr("aria-expanded","true"),this.fire("show"))},"_hide":function(t){this.isHidden()||(this._node.hide(),t&&t.silent||(this._node.attr("aria-expanded","false"),this.fire("hide")))},"_build":function(){var e=this;this._node=l.one(o.create(t.substitute('<div class="tbr-input-menu J_convePop" id="{id}" role="listbox" aria-expanded="false" style="display:none;"><ul></ul></div>',{"id":this.get("id")}))),this._node.appendTo(document.body),this._node.delegate("mouseover","a",function(t){e.set("selectedIndex",1*l.one(t.target).parent("li").attr("data-index"))}).delegate("click","a",function(t){t.preventDefault()}),this._mousedownMenuItemDOMNode=null,this._node.one("ul").on("mousedown",function(n){t.log("mousedown: "+n.target.nodeName);var i,r=l.one(n.target),o=r.prop("nodeName").toUpperCase();n.target!=this&&(i="LI"!=o?r.parent("li"):r,e._mousedownMenuItemDOMNode=i.getDOMNode())}).on("mouseup",function(n){t.log("mouseup: "+n.target.nodeName);var i,r,o=l.one(n.target),a=o.prop("nodeName").toUpperCase();if(n.target!=this){if(l.one(n.target).hasClass("tbr-delete"))return;r="LI"!=a?o.parent("li"):o,r.getDOMNode()==e._mousedownMenuItemDOMNode&&(i=r.attr("data-index"),i>-1&&(e.hide(),e.fire("select",{"value":e.get("dataArr")[i].value})))}}).on("click",function(e){t.log("click: "+e.target.nodeName),("A"==e.target.nodeName||l.one(e.target).parent("a"))&&e.preventDefault()}),this._node.on("mousedown",function(n){t.log("container mousedown: "+n.target.nodeName),u.ie&&u.ie<9&&(e._inputNode.getDOMNode().onbeforedeactivate=function(){window.event.returnValue=!1,this.onbeforedeactivate=null}),n.preventDefault()}),this.fire("init")},"_load":function(e){var n,i=[],o=this;t.each(e,function(r,a){var s=t.mix({},r);s.index=a,s.len=e.length,s.id=o.get("id"),i.push(s),r.selected&&(n=a)}),this._node.one("ul").html(new r(this._getTemplate()).render({"arr":i})),this.set("dataArr",i),t.isUndefined(n)?(this.reset("selectedIndex"),this.set("selectedIndex",0)):this.set("selectedIndex",n),this.fire("load")},"show":function(e){if(!this._isInitialized){if(!(t.isArray(e)&&e.length>0))return;this._build(),this._isInitialized=!0}t.isArray(e)&&e.length>0&&this._load(e),this._show(),this._locate()},"_locate":function(){var t=this._inputNode.parent(this.config.inputContainer),e=t.offset(),n=t.css("border-bottom-width")+"",i=n.match(/^(\d+)(px)?$/),r=0;n=i?1*i[1]:0,u.ie<8&&(r=0),this._node.css("left",e.left+"px"),this._node.css("top",e.top+t.outerHeight()-n+r+"px")},"hide":function(t){this._hide(t)},"getMenuNode":function(){return this._node},"_getTemplate":function(){return d+this.get("itemTemplate")+c},"getValue":function(){var t="",e=this.get("selectedIndex");return e>=0&&(t=this.get("dataArr")[e].value),t},"isHidden":function(){var t;return t=!this._node||"none"==this._node.css("display")}},{"ATTRS":{"itemTemplate":{"value":"{{value}}"},"dataArr":{"value":[]},"selectedIndex":{"value":-1,"validator":function(e){var n=!1;this.get("selectedIndex");return(t.isNumber(e)&&e>=0&&e<this.get("dataArr").length||e==-1)&&(n=!0),n}},"id":{"value":"","validator":function(e){return t.isString(e)}}}}),h});KISSY.add("tbr/history/phoneNumber",["kg/offline/2.0.0/index","io"],function(t,e,n,i){var o=e("kg/offline/2.0.0/index"),r=e("io"),a={},s=new o;return t.mix(a,{"_get":function(e){var n,i=t.tbr.numberHistory.max;t.tbr.loggedIn?(t.log("[history-phonenumber]get history from user's phonebook"),r({"url":t.substitute("//{hostname}/chargecontact/query_lastcharge_contact.htm",{"hostname":/daily\.taobao\.net/.test(location.hostname)?"tcc.daily.taobao.net":"tcc.taobao.com"}),"scriptCharset":"gbk","dataType":"jsonp","cache":!1,"timeout":5,"error":function(t,e){throw new Error(e)},"success":function(n){var o=[],r=[];n.success?(t.each(n.phoneBook,function(e,n){return(!i||r.length!=i)&&void(t.inArray(e.phoneNum,r)||(r.push(e.phoneNum),o.push({"id":e.id,"number":e.phoneNum,"name":e.userName})))}),t.log("[history-phonenumber]history is founded"),0==o.length&&t.log("[history-phonenumber]history is empty")):t.log("[history-phonenumber]shit happens, make the history empty"),t.namespace("tbr.numberHistory",t).phone=o,t.namespace("tbr.numberHistory",t).phoneSrc="cloud",t.isFunction(e)&&e(o,"cloud")}})):(t.log("[history-phonenumber]get history from local storage"),n=this._getLocalStorage().splice(0,i),t.namespace("tbr.numberHistory",t).phone=n,t.namespace("tbr.numberHistory",t).phoneSrc="local",t.isFunction(e)&&e(n,"local"))},"get":function(e){var n,i;t.log("[history-phonenumber]checking cache..."),n=t.namespace("tbr.numberHistory",t).phone,i=t.namespace("tbr.numberHistory",t).phoneSrc,n&&n.length?(t.log("[history-phonenumber]history is found"),t.isFunction(e)&&e(n,i)):this._get(e)},"deleteNumber":function(e,n){var i,o,a=t.namespace("tbr.numberHistory",t).phone;t.each(a,function(t,n){t.number===e&&(i=t.id,o=n)}),r({"url":t.substitute("//{hostname}/chargecontact/delete_recharge_contact.htm",{"hostname":/daily\.taobao\.net/.test(location.hostname)?"tcc.daily.taobao.net":"tcc.taobao.com"}),"scriptCharset":"gbk","dataType":"jsonp","data":{"contactId":i},"cache":!1,"timeout":5,"error":function(t,e){throw new Error(e)},"success":function(e){e.data&&e.data.delResult&&(t.namespace("tbr.numberHistory",t).phone=a.splice(i,1),n(e))}})},"addToLocalStorage":function(e){var n,i;t.log("[history-phonenumber]checking cache..."),n=t.namespace("tbr.numberHistory",t).phone,n||(t.log("[history-phonenumber]get from local storage"),n=this._getLocalStorage()),i=this._indexOf(e,n),i!=-1&&(t.log("[history-phonenumber]find that the number is already in local storage"),t.log("[history-phonenumber]remove it first")),t.log("[history-phonenumber]add the number"),n.unshift({"number":e}),n.length>10&&(t.log("[history-phonenumber]too many items, clean..."),n.splice(10)),t.log("[history-phonenumber]update..."),t.tbr.loggedIn||(t.tbr.numberHistory.phone=n),s.setItem("tbr.numberHistory.phone",this._param(n)),t.log("[history-phonenumber]local storage string is: "+s.getItem("tbr.numberHistory.phone")||"empty")},"_getLocalStorage":function(){var e,n=[];return e=s.getItem("tbr.numberHistory.phone"),t.log("[history-phonenumber]local storage string is: "+e||"empty"),e&&(n=this._unparam(e),n&&n.dataArr&&(n=n.dataArr)),n},"_indexOf":function(e,n){var i=-1;return t.each(n,function(t,n){if(t.number==e)return i=n,!1}),i},"_param":function(e){var n=[];return t.each(e,function(t){n.push(t.number)}),n.join(",")},"_unparam":function(e){var n=e.split(","),i=[];return t.each(n,function(t){i.push({"number":t,"value":t})}),i}}),a});KISSY.add("tbr/utils/numberUtils",["io"],function(t,e,n,r){var i=e("io"),a={};return a.format=function(t){var e=t;if(/^1\d{10}$/.test(t)){var n=t.match(/^(\d{3})(\d{4})(\d{4})$/);e=n[1]+"-"+n[2]+"-"+n[3]}else if(/^0\d{9,11}$/.test(t)){var r=this.getDistrictNumber(t);""!==r&&(e=r+"-"+t.substring(r.length))}return e},a.format2=function(t){var e="",n=t.length;return"1"==t.charAt(0)?(n<4?e=t:(e=t.substring(0,3),e+=n<8?"-"+t.substring(3,n):"-"+t.substring(3,7)+"-"+t.substring(7,n)),3!=n&&7!=n||(e+="-")):e="0"==t.charAt(0)?n<=2?t:/^0(10|2([0-5]||[7-9]))/.test(t)?t.substring(0,3)+"-"+t.substring(3,n):t.length<4?t:t.substring(0,4)+"-"+t.substring(4,n):t,e},a.getDistrictNumber=function(t){var e="";return/^0\d{9,11}$/.test(t)&&(e=/^0(10|2([0-5]||[7-9]))/.test(t)?t.substring(0,3):t.substring(0,4)),e},a.getProvince=function(e){var n="";if(t.isString(e)&&/^0[1-9]\d{2}/.test(e))switch(e.substring(1,3)){case"10":n="\u5317\u4eac";break;case"21":n="\u4e0a\u6d77";break;case"22":n="\u5929\u6d25";break;case"23":n="\u91cd\u5e86";break;case"24":n="\u8fbd\u5b81";break;case"25":n="\u6c5f\u82cf";break;case"27":n="\u6e56\u5317";break;case"28":n="\u56db\u5ddd";break;case"29":n="\u9655\u897f";break;case"20":n="\u5e7f\u4e1c";break;case"31":case"32":case"33":n="\u6cb3\u5317";break;case"34":case"35":n="\u5c71\u897f";break;case"37":case"38":case"39":n="\u6cb3\u5357";break;case"41":case"42":n="\u8fbd\u5b81";break;case"43":case"44":n="\u5409\u6797";break;case"45":case"46":n="\u9ed1\u9f99\u6c5f";break;case"47":case"48":n="\u5185\u8499\u53e4";break;case"51":case"52":n="\u6c5f\u82cf";break;case"53":case"54":case"63":n="\u5c71\u4e1c";break;case"55":case"56":n="\u5b89\u5fbd";break;case"57":case"58":n="\u6d59\u6c5f";break;case"59":n="\u798f\u5efa";break;case"71":case"72":n="\u6e56\u5317";break;case"73":case"74":n="\u6e56\u5357";break;case"75":case"76":case"66":n="\u5e7f\u4e1c";break;case"77":n="\u5e7f\u897f";break;case"79":case"70":n="\u6c5f\u897f";break;case"81":case"82":case"83":n="\u6c5f\u897f";break;case"85":n="\u8d35\u5dde";break;case"87":case"88":case"69":n="\u4e91\u5357";break;case"89":n="8"===e.charAt(3)?"\u6d77\u5357":"\u897f\u85cf";break;case"91":n="\u9655\u897f";break;case"93":case"94":n="\u7518\u8083";break;case"95":n="\u5b81\u590f";break;case"97":n="\u9752\u6d77";break;case"99":case"90":n="\u65b0\u7586"}return n},a.NUMBER_TYPE={"UNKNOWN":0,"TEL":1,"FIXED":2,"ARR":[0,1,2]},a.validate=function(t,e){var n="";return e||(e=this.NUMBER_TYPE.UNKNOWN),n=""==t?e==this.NUMBER_TYPE.TEL?"\u8bf7\u8f93\u5165\u624b\u673a\u53f7\u7801":e==this.NUMBER_TYPE.FIXED?"\u8bf7\u8f93\u5165\u56fa\u5b9a\u7535\u8bdd\u53f7\u7801":"\u8bf7\u8f93\u5165\u5145\u503c\u53f7\u7801":e==this.NUMBER_TYPE.TEL?/^1\d{10}$/.test(t)?"":/^0/.test(t)?"\u4e0d\u652f\u6301\u56fa\u5b9a\u7535\u8bdd\u53f7\u7801":"\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u624b\u673a\u53f7\u7801":e==this.NUMBER_TYPE.FIXED?/^0\d{9,11}$/.test(t)?"":/^1/.test(t)?"\u4e0d\u652f\u6301\u624b\u673a\u53f7\u7801":"\u53f7\u7801\u6709\u8bef\uff0c\u56fa\u8bdd\u8bf7\u52a0\u533a\u53f7":/^(1\d{10})|(0\d{9,11})$/.test(t)?"":/^1/.test(t)?"\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u624b\u673a\u53f7":"\u53f7\u7801\u6709\u8bef\uff0c\u56fa\u8bdd\u8bf7\u52a0\u533a\u53f7"},a.isFixedNumber=function(t){return/^(0\d{9,11})$/.test(t)},a.isTelNumber=function(t){return/^(1\d{10})$/.test(t)},a._getCarrierStr=function(t){var e=t.match(/\u79fb\u52a8|\u8054\u901a|\u7535\u4fe1|\u963f\u91cc\u901a\u4fe1/);return e&&e[0]||""},a._numberInfoCache={},a._tccUrlBase=t.substitute("//{hostname}/cc/json/mobile_tel_segment.htm",{"hostname":/assets\.daily\.taobao\.net/.test(t.Config.base)?"tcc.daily.taobao.net":"tcc.taobao.com"}),a.getNumberInfo=function(e,n,r){var a,o,s=this;if(t.log("[number-utils]start to get info of "+e),/^\d+$/.test(e))if(t.log("[number-utils]number is valid"),t.log("[number-utils]check cache"),a=this._numberInfoCache[e])if(t.log("[number-utils]cache is found"),1==a.code){if("\u963f\u91cc\u901a\u4fe1"===a.carrier){var l=a.area;a.area=""}n(a,l)}else r(a);else t.log("[number-utils]no cache"),a={},"1"==e.charAt(0)?(t.log("[number-utils]it's a telephone number, get its info from remote server"),i({"url":this._tccUrlBase,"dataType":"script","scriptCharset":"gbk","data":{"tel":e},"cache":!1,"timeout":5,"error":function(e,n){t.log("[number-utils]error happens during requesting, make the info unknown"),a.msg="\u53f7\u7801\u4fe1\u606f\u672a\u77e5",a.code=-1,t.isFunction(r)&&r(a)},"success":function(){var i=window.__GetZoneResult_;if(a.msg="",i.telString){if(t.log("[number-utils]info: "+i.province+", "+s._getCarrierStr(i.catName)),a.code=1,t.mix(a,{"carrier":i.carrier,"area":i.province,"number":e}),t.log("[number-utils]caching..."),"\u963f\u91cc\u901a\u4fe1"===a.carrier){a.area="";var o=i.province}s._numberInfoCache[e]=a,t.isFunction(n)&&n(a,o)}else a.code=-1,t.log("[number-utils]the info remains unknown"),a.error="\u53f7\u7801\u4fe1\u606f\u672a\u77e5",t.log("[number-utils]caching..."),s._numberInfoCache[e]=a,t.isFunction(r)&&r(a)}})):(t.log("[number-utils]it's a fixed number, try to guess its area info"),o=s.getProvince(e),""!=o?(t.mix(a,{"carrier":"\u56fa\u8bdd","area":o,"number":e}),s._numberInfoCache[e]=a,t.isFunction(n)&&n(a)):(a.error="\u53f7\u7801\u4fe1\u606f\u672a\u77e5",s._numberInfoCache[e]=a,t.isFunction(r)&&r(infoObj)))},a});KISSY.add("tbr/utils/keycode",[],function(t,e,n,r){return{"LEFT":37,"UP":38,"RIGHT":39,"DOWN":40,"ENTER":13,"ESC":27,"TAB":9,"inNumberBlacklist":function(t){var e=!1,n=t.keyCode,r=t.shiftKey,i=(t.ctrlKey,t.metaKey);return n&&(n*=1,((n>=96&&n<=105||n>=48&&n<=57)&&r||n>=65&&n<=90&&!i||n>=219&&n<=222||n>=186&&n<=192)&&(e=!0)),e}}});