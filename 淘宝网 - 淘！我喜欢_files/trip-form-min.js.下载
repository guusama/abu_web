/*! Generated by Clam: ntrip */
KISSY.add("ntrip/mods/common/trip-form",["dom","node","event","base","ua","json","kg/offline/6.0.4/index","kg/placeholder/6.0.0/index","../autocomplete/index-aria","../calendar/trip-calendar","../common/trip-common"],function(a,b){function c(b){var c=this;c.config=a.merge(o,b),c._init()}var d=(b("dom"),b("node")),e=(b("event"),b("base")),f=b("ua"),g=b("json"),h=b("kg/offline/6.0.4/index"),i=new h,j=b("kg/placeholder/6.0.0/index"),k=b("../autocomplete/index-aria"),l=b("../calendar/trip-calendar"),m=b("../common/trip-common"),n="select",o={placeHolder:!0,autoTabAttr:"data-autotab",submitCheck:!0,isStore:!0,isGetCityByIP:!0};return a.augment(c,e,{_init:function(){var a=this;a.formId=a.config.id,a.formNode=d.one(a.config.id),a.inputs=a.formNode.all("input"),a.config.autoComplete&&a.initAutoComplete(),a.config.calendar&&a.initCalendar(),a.config.placeHolder&&a._initPlaceHolder(),a.config.isStore&&a._initFormInfo(),a.config.isGetCityByIP&&a._getCityByIP(),a._bindUI()},_bindUI:function(){var b=this;b.formNode.on("submit",b.submitForm,b),6!=f.ie&&(a.each(b.autoComplete,function(a){a.on(n,function(){a.autoTab&&clearTimeout(a.autoTab),a.autoTab=setTimeout(function(){b._autoTab(a.inputNode)},100)},b)}),a.each(b.calendar,function(a){a.on("dateclick",function(){a.autoTab&&clearTimeout(a.autoTab),a.autoTab=setTimeout(function(){b._autoTab(a.getCurrentNode())},210)},b),a.on("show",function(){a.autoTab&&clearTimeout(a.autoTab)},b)}))},_getCityByIP:function(){var b=this;m.getCityByIP(),setTimeout(function(){a.each(b.inputs,function(b){var c=d.one(b),e=a.defaultCity;c.attr("data-ip")&&e&&e.name&&!a.trim(c.val())&&c.val(e.name)})},200)},_autoTab:function(b){var c=this,e=b.attr(c.config.autoTabAttr),b=d.one("#"+e);if(e&&b&&!a.trim(b.val())){var f=b.parent(".conve-input"),g="none"==f.css("display");!g&&b.getDOMNode().focus()}},_initFormInfo:function(){var a=this,b=i.getItem(a.formId);if(b)try{a._setInputValue(g.parse(b))}catch(c){}},storeFormInfo:function(){var b=this,c={};a.each(b.inputs,function(a){var b=d.one(a),e=b.val();"text"==b.attr("type")&&e&&(c[b.attr("name")]=e),"radio"==b.attr("type")&&b.attr("checked")&&(c[b.attr("name")]=e)}),i.setItem(b.formId,g.stringify(c))},_setInputValue:function(b){var c=this;a.each(c.inputs,function(a){var c=d.one(a);if("text"==c.attr("type")&&-1==c.attr("id").indexOf("Time")&&c.val(b[c.attr("name")]||""),"radio"==c.attr("type")){var e=c.val();e==b[c.attr("name")]&&c.attr("checked",!0)}})},_initPlaceHolder:function(){var b=this;b.placeHolder={},a.each(b.inputs,function(a){d.one(a).attr("placeholder")&&(b.placeHolder[d.one(a).attr("name")]=new j({node:a}))})},initCalendar:function(){var b=this;b.calendar={},a.each(b.config.calendar,function(a){b.calendar[a.id]=new l(a),b.calendar[a.id].on("show",function(a){var b=a.node;b.parent(".conve-input").addClass("conve-input-expand")}),b.calendar[a.id].on("hide",function(a){var b=a.oldNode;b&&b.parent(".conve-input").removeClass("conve-input-expand")})})},getCalendarById:function(a){var b=this;return b.calendar[a]},initAutoComplete:function(){var b=this;b.autoComplete={},a.each(b.config.autoComplete,function(a){b.autoComplete[a.inputNode]=new k(a),b.autoComplete[a.inputNode].on("afterVisibleChange",function(c){var d=b.autoComplete[a.inputNode].inputNode.parent(".conve-input");c.newVal?d.addClass("conve-input-expand"):d.removeClass("conve-input-expand")})})},getAutoCompleteById:function(a){var b=this;return b.autoComplete[a]},submitForm:function(a){a.halt()}}),c});