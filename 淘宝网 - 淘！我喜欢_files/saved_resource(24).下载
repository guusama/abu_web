KISSY.add("conve/rich-select/index",["node","dom","event","event-custom","conve/rich-select/index.css"],function(t,e,i,s){function o(t,e,i){if(!t)throw"rich-select: you must pass in a input element as first paramater!";this.initProperties(t,e,i),this.fillSelect(e,this.cfg),this.initUI(),this.regEvents(),this.initSelect()}var l=e("node"),n=e("dom"),a=e("event");e("event-custom"),e("conve/rich-select/index.css");var r=l.all,c="show",h="hide",d="onHide",u="onBeforeShow",p="onSelectChange",f="onSelectFilled",v="onSelectClear",g="onEnable",m="onDisable",w="onOptionRemove",x="onOptionAdd",C=37,b=38,O=39,y=40,S=13,I=27,M=9,B=".rich-select-title",R=".rich-select-body",D=".content-ctn",T=".J-option",k=".selected",W="rich-select-tip",A="show-as-table",E="selected",F="last-row-first-col",V="last-row-last-col",P="last-row",U="last-col",H="first-col",N="default",Y='<div id="{id}" class="rich-select {selectClass}" role="menu" aria-haspopup="false"><div class="gap" style="display:none;"></div><div class="rich-select-title {titleClass}">{title}</div><div class="rich-select-body  {bodyClass}"><div class="content-ctn"><dl class="{listClass}"></dl></div><div class="scroll-ctn"><div class="scroll-bar"><b class="top-1"></b><b class="top-2"></b><b class="bottom-2"></b><b class="bottom-1"></b></div></div></div><div class="rich-select-footer {footerClass}" style="display:none;">{footer}</div></div>',_='<dd id="{id}" role="menuitem" data-value="{value}" data-text="{text}" data-row="{row}" data-col="{col}" data-idx="{idx}" class="J-option {posiClass}" style="width:{width}">{content}</dd>',z=function(t){return'<a href="javascript:;" title="'+t.text+'">'+t.text+"</a>"};return t.augment(o,{setValue:function(t){this.selectOption("value",t)},getValue:function(){var t=this.selected,e=t?r(t).attr("data-value"):"";return e},getText:function(){var t=this.selected,e=t?r(t).attr("data-text"):"";return e},setOption:function(t){this.selectOption(t)},getOption:function(){return this.selected.attr("data-idx")},getItem:function(){return this.data[this.getOption()]},getOptionById:function(t){return this.optionData?this.optionData[t]:null},getOptions:function(){return this.optionData},show:function(){if(this.status!=c){var t=this.elem,e=this.getSelectPosi(),i=this.selected||r(t).all(T)[0];this.status=c,this.fire(u,{posi:e,elem:t},this.cfg.context),r(this.input).attr({"aria-haspopup":!0,"aria-expanded":!0}),r(t).attr({"aria-haspopup":!0,"aria-expanded":!0}),r(t).all(k).removeClass(E),r(i).addClass(E),r(t).css(e).show(),r(this.input)[0].focus(),this.updateScroll(),this.scrollOptionIntoView(i),this.selected?this.readSelectOption(this.selected):this.readActiveOption(i)}},hide:function(){this.status!=h&&(this.status=h,this.fire(d,null,this.cfg.context),r(this.input).attr({"aria-haspopup":!1,"aria-expanded":!1}),r(this.elem).attr({"aria-haspopup":!1,"aria-expanded":!1}).hide())},selectOption:function(){var t=arguments,e=this.getOptionNode(t);if(e&&0!=e.length){var i=!(t.length>1&&0==t[t.length-1]),s=(this.scrollBar,e.attr("data-text")),o=e.attr("data-value"),l=this.cfg;if(r(this.input).val(s.slice(0,l.inputMaxLen)),r(this.input).attr({title:s,"data-value":o}),!this.selected||o!=this.selected.attr("data-value")){if(this.selected&&r(this.selected).removeClass(E),this.selected=e,this.scrollOptionIntoView(e),this.readSelectOption(e),i){var n=this.getOption();this.fire(p,{text:s,value:o,index:n,item:this.data[n]},l.context)}this.input.removeClass(W)}}},fillSelect:function(t,e){r(this.input).val(""),this.isScrollUpdate=!1,this.optionData.length=0,this.selected=null,this.clearOptions(),this.renderOptions(t,e),this.status==c&&(this.updateScroll(),this.scrollOptionIntoView(this.selected||r(this.elem).all(T)[0])),e&&0==e.fireEvent||this.fire(f,{options:t},this.cfg.context),this.initSelect(e)},cancelSelect:function(){var t=this.input;r(this.selected).removeClass(E),r(t).val("").attr({title:"","data-value":""}),this.selected=null},clear:function(){r(this.input).val(""),this.selected=null,this.optionData.length=0,this.isScrollUpdate=!1,this.clearOptions(),this.status==c&&(this.updateScroll(),this.scrollOptionIntoView(this.selected||r(this.elem).all(T)[0])),this.fire(v,null,this.cfg.context)},setOptionContentRender:function(e){t.isFunction(e)&&(this.optionContentRender=e)},addOption:function(e){e=t.isArray(e)?e:[e],this.renderOptions(e),this.isScrollUpdate=!1,this.status==c&&(this.updateScroll(),this.scrollOptionIntoView(this.selected||r(this.elem).all(T)[0])),this.fire(x,e,this.cfg.context)},removeOption:function(){var t,e,i,s,o,l,n,a,h,d,u,f=Array.prototype.slice.call(arguments),v=this.getOptionNode(f),g=parseInt(r(v).attr("data-idx"),10),m=r(this.elem).all(R).all("dd"),x=this.optionData,C=this.cfg;for(r(v).remove(),l=x.splice(g,1),n=this.cfg.cols,a=this.getRowCount(),u=this.getColWidthFn(C.width,n,C.scrollWidth,C.optionBoxInfo),t=g,e=x.length;e>t;t++)i=m[t],d=t%n,h=Math.floor(t/n),s=i.className,o=this.getPosiClass(h,d,a,n),r(i).attr({"data-idx":t,"data-row":h,"data-col":d,"class":s.replace(/\blast-\w+\b/,o)}).css("width",u(o));this.isScrollUpdate=!1,this.status==c&&(this.updateScroll(),this.scrollOptionIntoView(this.selected||r(this.elem).all(T)[0])),r(this.selected).attr("data-idx")==g&&(this.selected=null,r(this.input).val("").attr({title:"","data-value":""}),this.fire(p,{text:"",value:""},this.cfg.context)),this.fire(w,l,this.cfg.context)},setEnable:function(t){var e=t?g:m;this.hide(),r(this.input).attr("disabled",!t),this.fire(e,null,this.cfg.context)},isEnable:function(){return!r(this.input).attr("disabled")},onInputBlur:function(t){var e=this;this.isCursorIn=!1,window.setTimeout(function(){e.isCursorIn||e.hide()},200)},onInputFocus:function(t){this.isCursorIn=!0},onInputClick:function(t){var e=this.input;1!=r(e)[0].disabled&&(this.status!=c?this.show():this.hide())},onOptionClick:function(t){t.preventDefault();var e=r(t.currentTarget);e!=this.selected&&this.selectOption(e),r(this.input)[0].focus(),this.hide()},onKeydown:function(t){var e,i,s=this.elem,o=t.keyCode;return o!=M?(t.preventDefault(),o==S?void(this.status==h?this.show():(r(this.input)[0].focus(),e=r(s).all(k),this.selectOption(e),this.hide())):o==I?void(this.status==c&&(this.hide(),r(this.input)[0].focus())):o==b||o==O||o==y||o==C?(e=r(s).all(k)[0]||r(s).all(T)[0],i=this.focusNext(e,o),void this.readActiveOption(i)):void 0):void 0},onWinResize:function(t){if(this.status==c){var e=this.elem,i=this.getSelectPosi();r(e).css(i)}},onScrollMouseDown:function(t){if(2!=t.button){t.preventDefault();var e=t.clientY,i=r(this.scrollBar)[0],s=r(this.elem).all(D)[0],o=parseInt(r(i).css("top"),10),l=s.scrollHeight,n=s.offsetHeight,c=l/n,h=o-e,d=n-r(i).height(),u=0,p=function(){a.remove(document.body,"mouseup",p),a.remove(document.body,"mousemove",f),document.all&&i.releaseCapture()},f=function(t){var e=t.clientY,o=u>=e+h?u:e+h>=d?d:e+h;r(i).css("top",o+"px"),r(s).scrollTop(Math.floor(o*c)+"px")};a.on(document.body,"mouseup",p),a.on(document.body,"mousemove",f),document.all&&i.setCapture()}},onMouseWheel:function(t){t.preventDefault();var e=r(this.scrollBar)[0],i=r(this.elem).all(D)[0],s=parseInt(r(e).css("top"),10),o=i.scrollHeight,l=i.offsetHeight,n=o/l,a=-(t.deltaY*l)/5,c=l-r(e).height(),h=0,s=h>=s+a?h:s+a>=c?c:s+a;r(e).css("top",s+"px"),r(i).scrollTop(Math.floor(s*n)+"px")},renderFrame:function(e,i){var s=i.template||Y,e=t.merge({id:this.id},i);return n.create(t.substitute(s,e))},renderOptions:function(e,i){i=i||{};var s,o=this.cfg,l=r(this.elem).all("dl")[0],a=this.optionData,c=this;i.colCount&&i.colCount!=o.cols&&(s=l.className,o.cols=i.colCount,l.className=s.replace(/\bcol\d/," col"+i.colCount+" ")),a.push.apply(a,e);var h=o.cols,d=this.getRowCount(),u=i.optionTemplate||_,p=this.optionContentRender,f=this.getColWidthFn(o.width,h,o.scrollWidth,o.optionBoxInfo);t.each(e,function(e,i){var s=i%h,o=Math.floor(i/h),a=c.getPosiClass(o,s,d,h),v=t.substitute(u,t.merge({content:p(e),posiClass:a,id:"_mi_"+t.guid(),row:o,col:s,idx:i,width:f(a)},e));r(l).append(n.create(v))})},clearOptions:function(){var t=r(this.elem).all("dl");t.all(T).remove()},getSelectPosi:function(){var t=this.cfg,e=t.align,i=t.alignTo,s=t.xoffset,o=t.yoffset,l=n.offset(i),a="left"!=e?"right":"left",c={top:l.top+r(i).height()+o};return c[a]=l[a]+s,c},getColWidthFn:function(t,e,i,s){var o=t-i,l=Math.floor(o/e),n=o%e,a=s.lb||0,r=s.rb||0,c=s.lp||0,h=s.rp||0,d=l-a-c-r-h+"px",u=l+n-c-r-h+"px",p=l-c-r-h+"px",f={};return f[N]=d,f[H]=u,f[U]=p,f[F]=u,f[V]=p,function(t){return f[t]||f[N]}},getPosiClass:function(t,e,i,s){return t==i-1&&e==s-1?V:t==i-1&&0==e?F:t==i-1?P:e==s-1?U:0==e?H:""},getConfig:function(e,i){var s=i.fireClickArea||r(e).parent(),o=i.alignTo||e,l=r(o).width(),n=t.merge({fireClickArea:s,showScroll:!1,displayRows:8,cols:1,xoffset:0,yoffset:0,width:l,align:"left",alignTo:o,context:this,inputMaxLen:100},i);return n.hasOwnProperty("scrollWidth")||(n.scrollWidth=n.showScroll?10:0),n.optionBoxInfo||(n.optionBoxInfo=n.listClass==A?{lb:1,lp:0,rb:1,rp:0}:{lb:0,lp:0,rb:0,rp:4}),n},getRowCount:function(){var t=this.cfg.cols,e=this.optionData;return e?Math.ceil(e.length/t):0},focusNext:function(e,i){var s=parseInt(r(e).attr("data-idx"),10),o=(r(e).attr("data-row"),r(e).attr("data-col"),r(this.elem).all(T)),l=this.cfg.cols,n=o.length,a=i==C?-1:i==b?-l:i==O?1:i==y?l:0,c=0>s+a?0:s+a>=n?n-1:s+a,h=o[c];return t.each(o,function(t,e){t==h?r(t).addClass(E):r(t).removeClass(E)}),this.scrollOptionIntoView(h),h},readActiveOption:function(t){var e=r(this.input),i=r(t).attr("id");e.attr("aria-activedescendant",i)},readSelectOption:function(t){var e=(r(this.input),r(t).attr("id"),r(t).attr("data-text"));t.attr({title:"��ѡ����:"+e,"aria-label":"��ѡ����:"+e})},initProperties:function(e,i,s){var o=i?i.length:0;s.showScroll=(s.displayRows||0)<o?!0:!1,s=this.getConfig(e,s),this.id=s.id||"_rs_"+t.guid(),this.status=h,this.EventMap={},this.selected=null,this.optionData=[],this.isCursorIn=!1,this.isScrollUpdate=!1,this.data=i,this.optionContentRender=t.isFunction(s.optionContentRender)?s.optionContentRender:z,this.cfg=s,this.input=r(e),this.elem=this.renderFrame(i,s),this.scrollCtn=r(this.elem).all(".scroll-ctn"),this.scrollBar=r(this.scrollCtn).all(".scroll-bar")},initUI:function(){var t=this.elem,e=this.cfg,i=document.body,s=this.input,o=e.label;r(s).attr({role:"combobox",title:o,"aria-ows":this.id,readOnly:!0,"aria-live":"assertive","aria-label":o,"aria-readOnly":!0,"aria-haspopup":"false","aria-expanded":"false","aria-autocomplete":"list"}),r(t).hide(),r(i).append(this.elem),e.width&&r(t).css("width",e.width+"px"),e.title||r(t).all(B).hide(),e.showGap&&this.initGap()},initGap:function(){return},regEvents:function(){var t=this.input,e=this.elem,i=this.cfg,s=i.fireClickArea;a.on(window,"resize",this.onWinResize,this),a.on(t,"blur",this.onInputBlur,this),a.on(t,"focus",this.onInputFocus,this),a.on(t,"keydown",this.onKeydown,this),a.on(s,"click",this.onInputClick,this),a.on(this.scrollBar,"mousedown",this.onScrollMouseDown,this),a.delegate(e,"click",T,this.onOptionClick,this),a.on(e,"mousewheel",this.onMouseWheel,this)},initSelect:function(e){var i=this,e=e||i.cfg;if(e){var s=e.selected;(s||0==s)&&(t.isArray(s)?i.selectOption.apply(i,s):i.selectOption(s)),e.placeHolder&&(i.input.val(e.placeHolder),i.input.addClass(W))}},updateScroll:function(){var t=this.cfg,e=r(this.elem),i=e.all(D),s=this.scrollCtn,o=this.optionData;if(t.showScroll&&!this.isScrollUpdate){if(this.isScrollUpdate=!0,!o||0==o.length)return i.css("height","auto"),void s.hide();var l,n=this.scrollBar,a=t.displayRows,c=e.all("dd"),h=c[0],d=(t.cols,this.getRowCount()),u=r(h).height()+parseInt(r(h).css("marginTop"),10)+parseInt(r(h).css("marginBottom"),10),p=a*u;a>=d?(i.css("height","auto"),s.hide()):(l=Math.floor(p*a/d)%2==0?Math.floor(p*a/d):Math.floor(p*a/d)-1,n.css("height",l+"px"),i.css("height",p+"px"),s.show())}},scrollOptionIntoView:function(t){if(t&&this.cfg.showScroll){t=r(t)[0];var e=this.scrollBar,i=r(this.elem),s=i.all(D)[0],o=s.getBoundingClientRect(),l=t.getBoundingClientRect(),n=l.top>=o.top&&l.bottom<=o.bottom;if(!n){var a,c=r(s).height(),h=s.scrollHeight;return l.bottom>o.bottom?(a=s.scrollTop+l.bottom-o.bottom,s.scrollTop=a,void r(e).css("top",Math.floor(a*c/h)+"px")):void(l.top<o.top&&(a=s.scrollTop+l.top-o.top,s.scrollTop=a,r(e).css("top",Math.floor(a*c/h)+"px")))}}},getOptionNode:function(e){if(1==e.length&&"object"==typeof e[0])return r(e[0]);var i=r(this.elem).all(T);if(1==e.length&&"number"==typeof e[0])return r(i[e[0]]);var s=null,o=e[1],l="text"==e[0]?"text":"value";return t.each(i,function(t){var e=r(t).attr("data-"+l);e==o&&(s=t)}),r(s)},on:function(t,e,i){var s=this.EventMap[t]||(this.EventMap[t]=[]);s.push(e,i)},fire:function(e,i,s){var o=this.EventMap[e];if(o&&0!=o.length){var l,n,a=[].slice.call(arguments),s=a.length>2?a[a.length-1]:null,i=a.length>2?a.slice(1,a.length-1):[],r=o.length;for(l=0;r>l;l++)if(n=o[l],"function"==typeof n)try{n.apply(s,i)}catch(c){t.error("rich-select: call event["+e+"]'s handler error, info: "+c)}}}}),o});